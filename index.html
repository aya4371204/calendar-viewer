<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会議室 利用状況ビューア (ウェブ版)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 20px; margin: 0; background-color: #f9f9f9; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        #authControls { text-align: center; margin-bottom: 20px; }
        #signInButton, #signOutButton { padding: 10px 15px; margin: 5px; cursor: pointer; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        #signInButton { background-color: #4285F4; color: white; border-color: #4285F4; }
        #signOutButton { background-color: #f1f1f1; }
        #controls-wrapper { margin-bottom: 20px; padding: 15px; background-color: #ecf0f1; border-radius: 8px; }
        #viewSelector, #controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        #controls input, #controls select, #controls button { padding: 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
        #dataDisplayArea { overflow: auto; width: 100%; max-height: 80vh; margin-top: 20px; }
        #dailyMatrixTable { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #dailyMatrixTable th, #dailyMatrixTable td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; font-size: 12px; vertical-align: middle; height: 38px; }
        #dailyMatrixTable thead th { background-color: #e9ecef; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        #dailyMatrixTable thead th:first-child { background-color: #e0e0e0; width: 200px; /* ★会議室名列の幅を200pxに固定 */ text-align: left; padding-left: 10px; position: sticky; left: 0; z-index: 12; }
        #dailyMatrixTable tbody td:first-child { width: 200px; /* ★会議室名列の幅を200pxに固定 */ white-space: nowrap; background-color: #f8f9fa; font-weight: bold; text-align: left; padding-left: 10px; overflow: hidden; text-overflow: ellipsis; position: sticky; left: 0; z-index: 2; }
        #dailyMatrixTable tbody td:not(:first-child) { min-width: 70px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; padding-left: 8px; }
        .matrix-cell-busy { background-color: #fadbd8; color: #333; cursor: help; text-align: center; }
        .matrix-cell-available { background-color: #d5f5e3; }
    </style>
</head>
<body>
    <h1>会議室 利用状況</h1>
    <div id="authControls">
        <button id="signInButton" style="display: none;">Googleでサインイン</button>
        <button id="signOutButton" style="display: none;">サインアウト</button>
    </div>
    <div id="controls-wrapper" style="display: none;">
        <div id="viewSelector">
            <label><input type="radio" name="viewType" value="dailyMatrix" checked> 日別マトリクス</label>
            <label><input type="radio" name="viewType" value="weeklyRoom"> 会議室別週間</label>
        </div>
        <hr>
        <div id="controls">
            <div id="dailyControls">
                <label for="dailyDatePicker">日付:</label>
                <input type="date" id="dailyDatePicker">
                <button id="prevDayBtn" title="前の日">&lt;</button>
                <button id="nextDayBtn" title="次の日">&gt;</button>
            </div>
            <div id="weeklyControls" style="display: none;">
                <label for="roomSelector">会議室:</label>
                <select id="roomSelector"></select>
                <label for="weekDisplay">表示週:</label>
                <span id="weekDisplaySpan"></span>
                <button id="prevWeekBtn" title="前の週">&lt;</button>
                <button id="nextWeekBtn" title="次の日">&gt;</button>
            </div>
        </div>
    </div>
    <div id="loading" style="display: none;">読み込み中...</div>
    <div id="error" style="display: none;"></div>
    <div id="dataDisplayArea"></div>
    <script src="calendar_viewer_web.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

2. JavaScript (calendar_viewer_web.js) - 修正済み
主な修正点: 全てのコードを整理し、変数のスコープ問題を解決しました。DOM要素の取得を一度だけ行い、すべての関数がそれらの変数を正しく参照できるようにしています。

// --- GAPI と GIS の初期化 (グローバルスコープ) ---
let tokenClient;
let gapiInited = false;
let gisInited = false;

// ★★★ GCPで作成したウェブアプリケーション用の情報を設定 ★★★
const API_KEY = 'AIzaSyCpRjx_lkdpcp-eePb-_psrh5MUB-T06aA';
const CLIENT_ID = '976002357617-j8i08ahpphr1frt1ko7tltvfbp847alk.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events.readonly';

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
    });
    gapiInited = true;
    document.dispatchEvent(new Event('gapiReady'));
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
    });
    gisInited = true;
    document.dispatchEvent(new Event('gisReady'));
}

// --- メインのアプリケーションロジック ---
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements ---
    const signInButton = document.getElementById('signInButton');
    const signOutButton = document.getElementById('signOutButton');
    const controlsWrapper = document.getElementById('controls-wrapper');
    const dataDisplayArea = document.getElementById('dataDisplayArea');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const viewSelectorRadios = document.querySelectorAll('input[name="viewType"]');
    const dailyControlsDiv = document.getElementById('dailyControls');
    const weeklyControlsDiv = document.getElementById('weeklyControls');
    const dailyDatePicker = document.getElementById('dailyDatePicker');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    const roomSelector = document.getElementById('roomSelector');
    const weekDisplaySpan = document.getElementById('weekDisplaySpan');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');

    // --- Resource Data ---
    const resourceCalendarItems = [
        { name: "J会議室-1", id: "qualitech-pharma.co.jp_1884fiuigavrkglnjs1djjhgku6im6gb6opj8dhg6gq30cpo70@resource.calendar.google.com" },
        { name: "J会議室-2", id: "c_188946m97jurmjcln23drb67jt08c@resource.calendar.google.com" },
        { name: "J会議室-3", id: "c_188ct4ddraj2sih1l1p8bki4kquua@resource.calendar.google.com" },
        { name: "C会議室-1", id: "c_1886tb6nndrgih6fntrba28bbqg3c@resource.calendar.google.com" },
        { name: "C会議室-2", id: "c_188e1galv71cqjldlqmcqb9bh13v0@resource.calendar.google.com" },
        { name: "J応接室-1", id: "c_188dv27enmm18gm0l374n8dsp7736@resource.calendar.google.com" },
        { name: "J応接室-2", id: "c_1883dlc3656j8iqdhu538n2bjtrug@resource.calendar.google.com" },
        { name: "TQ会議室-1", id: "c_1889knnqihfeegnuk0difag0k4mva@resource.calendar.google.com" },
        { name: "TQ会議室-2", id: "c_188dorsdoishij18ko42f4rmnip9o@resource.calendar.google.com" },
        { name: "KUBOMI", id: "c_1884ppicc7llijpbn2i563577na98@resource.calendar.google.com" },
        { name: "A棟包装会議室", id: "c_1884rmjrs0j4kio2kcj3s7ae7aki2@resource.calendar.google.com" },
        { name: "TQ棟１F 南側", id: "c_1880t51gi8ei6hufjuapnk2s5a7ns@resource.calendar.google.com" },
        { name: "TQ棟１F 北側", id: "c_18805c2gtqlrmgamn400g2mfl8gp0@resource.calendar.google.com" },
        { name: "ノア", id: "c_188610h41pnu2jrcgtt1daki34ccq@resource.calendar.google.com" },
        { name: "アクア", id: "c_1882goec90jfojkigr38jcc72sadu@resource.calendar.google.com" }
    ];

    // --- State Variables ---
    let currentView = 'dailyMatrix';
    let selectedDate = new Date();
    let currentSelectedRoomId = resourceCalendarItems.length > 0 ? resourceCalendarItems[0].id : null;
    let currentWeekStartDate = getMonday(new Date());

    // --- Helper Functions ---
    function showLoading(isLoading) { if (loadingDiv) loadingDiv.style.display = isLoading ? 'block' : 'none'; }
    function showError(message) { if (errorDiv) { errorDiv.textContent = message; errorDiv.style.display = message ? 'block' : 'none'; } }
    function getMonday(d) { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
    function formatDate(date) { const y = date.getFullYear(), m = ('0' + (date.getMonth() + 1)).slice(-2), d = ('0' + date.getDate()).slice(-2); return `${y}/${m}/${d}`; }
    function formatEventTimeForTooltip(eventStart, eventEnd) {
        const options = { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tokyo' };
        const startTime = new Date(eventStart.dateTime || eventStart.date).toLocaleTimeString('ja-JP', options);
        const endTime = new Date(eventEnd.dateTime || eventEnd.date).toLocaleTimeString('ja-JP', options);
        return `${startTime}～${endTime}`;
    }

    // --- GAPI/GIS readiness check ---
    function maybeEnableAuthButtons() { if (gapiInited && gisInited) { signInButton.style.display = 'block'; } }

    // --- Auth Logic ---
    signInButton.onclick = () => {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                showError('認証中にエラーが発生しました: ' + JSON.stringify(resp));
                throw (resp);
            }
            signOutButton.style.display = 'block';
            signInButton.style.display = 'none';
            controlsWrapper.style.display = 'block';
            gapi.client.setToken({ access_token: resp.access_token });
            fetchData();
        };
        if (gapi.client.getToken() === null) { tokenClient.requestAccessToken({ prompt: 'consent' }); } else { tokenClient.requestAccessToken({ prompt: '' }); }
    };

    signOutButton.onclick = () => {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                dataDisplayArea.innerHTML = '';
                controlsWrapper.style.display = 'none';
                signInButton.style.display = 'block';
                signOutButton.style.display = 'none';
                showError('サインアウトしました。');
            });
        }
    };

    // --- Data Fetching ---
    async function fetchData() {
        if (!gapi.client.getToken()) { showError("Googleアカウントでサインインしてください。"); return; }
        showLoading(true); showError(''); dataDisplayArea.innerHTML = '';
        let timeMinISO, timeMaxISO, idsToFetchDetails = [];
        if (currentView === 'dailyMatrix') {
            timeMinISO = new Date(new Date(selectedDate).setHours(0, 0, 0, 0)).toISOString();
            timeMaxISO = new Date(new Date(selectedDate).setHours(23, 59, 59, 999)).toISOString();
            idsToFetchDetails = resourceCalendarItems.map(item => item.id);
        } else {
            if (!currentSelectedRoomId) { showError("会議室が選択されていません。"); showLoading(false); return; }
            const weekEnd = new Date(currentWeekStartDate); weekEnd.setDate(currentWeekStartDate.getDate() + 6);
            timeMinISO = new Date(new Date(currentWeekStartDate).setHours(0, 0, 0, 0)).toISOString();
            timeMaxISO = new Date(weekEnd.setHours(23, 59, 59, 999)).toISOString();
            idsToFetchDetails = [currentSelectedRoomId];
        }
        if (idsToFetchDetails.length === 0) { showError("取得対象のリソースがありません。"); showLoading(false); return; }

        const allCalendarData = {};
        try {
            const requests = idsToFetchDetails.map(calendarId => gapi.client.calendar.events.list({ 'calendarId': calendarId, 'timeMin': timeMinISO, 'timeMax': timeMaxISO, 'showDeleted': false, 'singleEvents': true, 'maxResults': 50, 'orderBy': 'startTime' }));
            const responses = await Promise.all(requests);
            responses.forEach((response, index) => {
                const calendarId = idsToFetchDetails[index];
                if (response.result.items) {
                    allCalendarData[calendarId] = {
                        items: response.result.items.map(event => ({ id: event.id, summary: event.summary || '(タイトルなし)', start: event.start, end: event.end, organizer: event.organizer ? (event.organizer.displayName || event.organizer.email) : '(主催者不明)', attendees: event.attendees ? event.attendees.map(att => att.displayName || att.email) : [] }))
                    };
                }
            });
            showLoading(false);
            if (currentView === 'dailyMatrix') renderDailyMatrixView(allCalendarData); else renderWeeklyRoomView(allCalendarData);
        } catch (err) {
            showLoading(false); console.error("Error fetching calendar data: ", err); showError(`データ取得エラー: ${err.result.error.message || JSON.stringify(err)}`);
        }
    }

    // --- Rendering Logic ---
    function renderDailyMatrixView(calendarsEventData) {
        // ... (renderDailyMatrixView のロジックは変更なし) ...
    }
    function renderWeeklyRoomView(calendarsEventData) {
        // ... (renderWeeklyRoomView のロジックは変更なし) ...
    }

    // --- UI Control Logic ---
    function handleViewChange(event) { currentView = event.target.value; updateViewControls(); if (gapi.client.getToken()) fetchData(); }
    function updateViewControls() { dailyControlsDiv.style.display = currentView === 'dailyMatrix' ? 'block' : 'none'; weeklyControlsDiv.style.display = currentView === 'weeklyRoom' ? 'block' : 'none'; }
    function navigateDay(offset) { selectedDate.setDate(selectedDate.getDate() + offset); dailyDatePicker.valueAsDate = selectedDate; if (gapi.client.getToken()) fetchData(); }
    function navigateWeek(offset) { currentWeekStartDate.setDate(currentWeekStartDate.getDate() + (offset * 7)); updateWeekDisplay(); if (gapi.client.getToken()) fetchData(); }
    function updateWeekDisplay() { const e = new Date(currentWeekStartDate); e.setDate(currentWeekStartDate.getDate() + 6); weekDisplaySpan.textContent = `${formatDate(currentWeekStartDate)} - ${formatDate(e)}`; }

    // --- App Initialization ---
    (function initializeApp() {
        if (resourceCalendarItems.length === 0) { showError("確認するリソースカレンダーが設定されていません。"); return; }
        resourceCalendarItems.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = item.name; roomSelector.appendChild(option); });
        if (currentSelectedRoomId) roomSelector.value = currentSelectedRoomId;
        dailyDatePicker.valueAsDate = selectedDate; updateWeekDisplay(); updateViewControls();
        viewSelectorRadios.forEach(radio => radio.addEventListener('change', handleViewChange));
        dailyDatePicker.addEventListener('change', () => { selectedDate = dailyDatePicker.valueAsDate; if (gapi.client.getToken()) fetchData(); });
        prevDayBtn.addEventListener('click', () => navigateDay(-1)); nextDayBtn.addEventListener('click', () => navigateDay(1));
        roomSelector.addEventListener('change', () => { currentSelectedRoomId = roomSelector.value; if (gapi.client.getToken()) fetchData(); });
        prevWeekBtn.addEventListener('click', () => navigateWeek(-1)); nextWeekBtn.addEventListener('click', () => navigateWeek(1));
        document.addEventListener('gapiReady', maybeEnableAuthButtons); document.addEventListener('gisReady', maybeEnableAuthButtons);
        maybeEnableAuthButtons();
    })();
});
